<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />

  <!-- <link rel="stylesheet" type="text/css" href="style.css" /> -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <title>piMI</title>

  <style>
    html {
      background-color: #1e1e2e;
      color: #cdd6f4;
    }

    body {
      width: fit-content;
    }

    .resize {
      width: auto;
      display: flex;
      flex-wrap: wrap;
    }

    .graph {
      width: 50%;
      height: auto;
      aspect-ratio: 16 / 9;
    }

    .button-container {
      margin-left: auto;
      margin-right: auto;
      width: fit-content;
    }

    .button-container button {
      background-color: #313244;
      padding: 10px;
      color: #cdd6f4;
    }

    @media (max-width: 600px) {
      .resize {
        width: 95vw;
      }

      .graph {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <header>
    <!-- <picture selectable="false" draggable="false">
      <source selectable="false" draggable="false" srcset="/img/piMI.webp" type="image/webp">
      <source selectable="false" draggable="false" srcset="/img/piMI.png" type="image/png">
      <img selectable="false" draggable="false" src="/img/piMI.png" alt="piMI Logo" />
    </picture> -->
    <div class="resize">
      <div class="graph">
        <canvas id="cpuUsageGraph" aria-label="CPU Usage Graph" role="img">
          <p>Your browser does not support the canvas element for the CPU Usage Graph.</p>
        </canvas>
      </div>

      <div class="graph">
        <canvas class="graph" id="ramUsageGraph" aria-label="RAM Usage Graph" role="img">
          <p>Your browser does not support the canvas element for the RAM Usage Graph.</p>
        </canvas>
      </div>

      <div class="graph">
        <canvas class="graph" id="netUsageGraph" aria-label="Network Usage Graph" role="img">
          <p>Your browser does not support the canvas element for the Network Usage Graph.</p>
        </canvas>
      </div>

      <div class="graph">
        <canvas class="graph" id="dskUsageGraph" aria-label="Disk Usage Graph" role="img">
          <p>Your browser does not support the canvas element for the Disk Usage Graph.</p>
        </canvas>
      </div>
    </div>
  </header>
  <div class="button-container" id="manage">
    <button onclick="ws.send('short');"> Short Press </button>
    <button onclick="ws.send('long');"> Long Press </button>
    <button onclick="ws.send('reset');"> Reset </button>
  </div>
</body>

<script>
  // Establish WS
  // var ws = new WebSocket("ws://" + location.hostname); // Possibly update to wss:// later

  const cpus = [];
  const threads = 12; // Switch to static int when using off pico
  const colors = ["#f2cdcd", "#f5c2e7", "#f38ba8", "#eba0ac", "#fab387", "#f9e2af", "#a6e3a1", "#94e2d5", "#89dceb", "#74c7ec", "#89b4fa", "#b4befe"];
  const lineColors = ["#c3a5a5", "#ddafd1", "#d47993", "#cb8b95", "#e5a27c", "#e6d0a1", "#97ce92", "#82c7bc", "#7bc6d3", "#68b4d4", "#759ad6", "#9ea7de"];
  for (var thread = 0; thread < threads; thread++) {
    cpus.push({
      label: "CPU" + thread,
      data: [thread * 50 + 50, thread * 20 + 20, thread * 80 + 80, thread * 40 + 40, thread * 0 + 0, thread * 100 + 100, thread * 25 + 25,], //REPLACE BEFORE PUSH
      borderColor: lineColors[thread],
      backgroundColor: colors[thread],
      fill: 'stack'
    });
  }

  const cpuUsageGraph = document.getElementById('cpuUsageGraph');
  const ramUsageGraph = document.getElementById('ramUsageGraph');
  const netUsageGraph = document.getElementById('netUsageGraph');
  const dskUsageGraph = document.getElementById('dskUsageGraph');

  Chart.defaults.color = "#cdd6f4";
  Chart.defaults.borderColor = "#6c7086";

  const cpuUsageGraphChart = new Chart(cpuUsageGraph, {
    type: 'line',
    data: {
      labels: ['0', '5', '10', '15', '20', '25', '30', '35', '40', '45'],
      datasets: cpus
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        }
      }
    }
  });

  const ramUsageGraphChart = new Chart(ramUsageGraph, {
    type: 'doughnut',
    data: {
      labels: ["Used", "Free", "Cache"],
      datasets: [
        {
          label: "Current",
          data: [50, 60, 40],
          fill: true
        }
      ]
    },
    options: {
    }
  });

  const netUsageGraphChart = new Chart(netUsageGraph, {
    type: 'bar',
    data: {
      labels: ['0', '5', '10', '15', '20', '25', '30', '35', '40', '45'],
      datasets: [
        {
          label: "Recv",
          data: [50],
          fill: true
        }, {
          label: "Send",
          data: [-50],
          fill: true
        }
      ]
    },
    options: {
      scales: {
        x: {
          stacked: true
        },
        y: {
          stacked: true
        }
      }
    }
  });

  const dskUsageGraphChart = new Chart(dskUsageGraph, {
    type: 'bar',
    data: {
      labels: ['0', '5', '10', '15', '20', '25', '30', '35', '40', '45'],
      datasets: [
        {
          label: "Read",
          data: [80],
          fill: true
        }, {
          label: "Write",
          data: [-30],
          fill: true
        }
      ]
    },
    options: {
      scales: {
        x: {
          stacked: true
        },
        y: {
          min: -100,
          max: 100,
          stacked: true
        }
      }
    }
  });

  // Allows pushing new data to chart
  function addData(chart, list, stacked) {
    console.log(list.length)
    for (var i = 0; i < list.length; i++) {
      console.log(i)
      console.log(chart.data.datasets[i])
      // Make sure to not overfill graph
      length = chart.data.datasets[i].data.length
      if (length >= 10) {
        chart.data.datasets[i].data.shift();
      }
      // Add stacked support
      if (stacked) {
        value = 0;
        for (var j = 0; j <= i; j++) {
          value += list[j]
        }
        chart.data.datasets[i].data.push(value)
      } else {
        chart.data.datasets[i].data.push(list[i])
      }
    }
    chart.update();
  }

  ws.onmessage = function (evt) {
    // Get list from WS
    var list = JSON.parse(evt.data);

    // Make sure that the amount of threads is correct by checking if just the extra data is left
    if (list.length - threads != 8) {
      // TODO: Add error handling
      return
    }

    // Update CPU graph
    addData(cpuUsageGraphChart, list.slice(0, threads), true);

    // Update RAM graph
    addData(ramUsageGraphChart, list.slice(threads, threads + 3), false);

    // Update NET graph
    addData(netUsageGraphChart, list.slice(threads + 4, threads + 6), false);

    // Update DSK graph
    addData(dskUsageGraphChart, list.slice(threads + 6, threads + 8), false);
  };
</script>

</html>